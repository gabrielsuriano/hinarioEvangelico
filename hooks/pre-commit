#!/bin/sh

# Hook pre-commit: Sincroniza√ß√£o de vers√£o e verifica√ß√£o de trailing spaces
# O versionamento autom√°tico acontece no prepare-commit-msg

echo "üîÑ Verificando sincroniza√ß√£o de vers√£o..."

# Executa o script de sincroniza√ß√£o
node scripts/sync-version.js

if [ $? -ne 0 ]; then
  echo "‚ùå Falha na sincroniza√ß√£o de vers√£o. Commit cancelado."
  exit 1
fi

# Adiciona nuxt.config.ts ao commit se foi modificado
git add nuxt.config.ts 2>/dev/null || true

echo "‚úÖ Sincroniza√ß√£o de vers√£o OK!"

# Verifica trailing spaces nos arquivos staged
echo "üßπ Verificando trailing spaces..."

# Obt√©m lista de arquivos staged (apenas arquivos que existem)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue|json|md|css|html|yml|yaml)$')

if [ -n "$STAGED_FILES" ]; then
  HAS_TRAILING_SPACES=false

  for FILE in $STAGED_FILES; do
    # Verifica se o arquivo tem trailing spaces
    if grep -q '[[:space:]]$' "$FILE" 2>/dev/null; then
      if [ "$HAS_TRAILING_SPACES" = false ]; then
        echo "‚ùå Trailing spaces encontrados em:"
        HAS_TRAILING_SPACES=true
      fi
      echo "   - $FILE"
    fi
  done

  if [ "$HAS_TRAILING_SPACES" = true ]; then
    echo ""
    echo "üí° Execute 'node scripts/remove-trailing-spaces.js' para corrigir."
    echo "   Ou adicione a flag --no-verify para ignorar esta verifica√ß√£o."
    exit 1
  fi
fi

echo "‚úÖ Nenhum trailing space encontrado!"
exit 0
