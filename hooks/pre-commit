#!/bin/sh

# Hook pre-commit: SincronizaÃ§Ã£o de versÃ£o e verificaÃ§Ã£o de trailing spaces
# O versionamento automÃ¡tico acontece no prepare-commit-msg

echo "ðŸ”„ Verificando sincronizaÃ§Ã£o de versÃ£o..."

# Executa o script de sincronizaÃ§Ã£o
node scripts/sync-version.js

if [ $? -ne 0 ]; then
  echo "âŒ Falha na sincronizaÃ§Ã£o de versÃ£o. Commit cancelado."
  exit 1
fi

# Adiciona nuxt.config.ts ao commit se foi modificado
git add nuxt.config.ts 2>/dev/null || true

echo "âœ… SincronizaÃ§Ã£o de versÃ£o OK!"

# Verifica e remove trailing spaces automaticamente
echo "ðŸ§¹ Verificando trailing spaces..."

# ObtÃ©m lista de arquivos staged (apenas arquivos que existem)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|ts|vue|json|md|css|html|yml|yaml)$')

if [ -n "$STAGED_FILES" ]; then
  HAS_TRAILING_SPACES=false

  for FILE in $STAGED_FILES; do
    # Verifica se o arquivo tem trailing spaces
    if grep -q '[[:space:]]$' "$FILE" 2>/dev/null; then
      HAS_TRAILING_SPACES=true
      break
    fi
  done

  if [ "$HAS_TRAILING_SPACES" = true ]; then
    echo "ðŸ”§ Removendo trailing spaces automaticamente..."
    node scripts/remove-trailing-spaces.js

    # Re-adiciona os arquivos staged que foram modificados
    for FILE in $STAGED_FILES; do
      git add "$FILE" 2>/dev/null || true
    done

    echo "âœ… Trailing spaces removidos e arquivos atualizados!"
  else
    echo "âœ… Nenhum trailing space encontrado!"
  fi
else
  echo "âœ… Nenhum arquivo elegÃ­vel para verificaÃ§Ã£o!"
fi
exit 0
